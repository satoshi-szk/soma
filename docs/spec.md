# SOMA 仕様

Sonic Observation, Musical Abstraction

## 概要

スペクトログラム上で人間が指定したパーシャルを取り出して、それを MPE の MIDI などいくつかのフォーマットで書き出すGUI アプリケーション

## 入力音の例:

- 雨樋に雨が落ちる音など、ノイズとピッチの混在する素材・環境音
- 楽器や歌などのピッチやハーモニーのある素材
- モードと

## ワークフローの例:

- Wavelet 変換 -> スペクトログラム表示
- ユーザーがスペクトログラム上から必要なパーシャルの上をペンシルツールでなぞる（マウスドラッグ）
- なぞったパスに一番近いリッジの周波数・振幅の集合が「パーシャル」としてグルーピング、記録される（リッジへのスナップ処理）
- ユーザーがエクスポートを選ぶと MPE の SMF などでパーシャルが書き出される。1パーシャルが1ノートに対応する。

## エクスポートフォーマットの例

- SMF
- オーディオファイル（モジュラーシンセサイザーのCV用）

## MVP機能一覧

- スペクトログラム表示
- ペンシルツールによるパーシャルの指定
- パーシャルの削除、結合、延長、クロップなど編集機能
- 編集の Undo / Redo
- 入力オーディオファイルの再生
- パーシャルの再生（サイン波によるResynthesis）
- 入力音（原音）と再合成音のミックス再生（原音/再合成 1ノブ）
- パーシャルごとのミュート・アンミュート

## 将来追加したい機能

- Vamp プラグインを使った解析
- Vamp プラグインやビルトインのアナライザーの出力の時系列データを CV として書き出し

# 技術仕様

- macOS, Windows 必須
- できれば Linux

## メモ

- 商用アプリではない。研究・創作用ツール。
- スナップ処理
    - 描画中（ドラッグ中）はスナップせず、マウスの軌跡をそのまま表示する。
    - `MouseUp` のタイミングで Backend に軌跡を送り、JIT解析でリッジ（局所最大）を検出してスナップさせる。
    - **重要:** スナップ処理は CWT による JIT 解析のみで行い、STFT は絶対に使用しない（STFT は GUI プレビュー専用）。
- スペクトログラム（プレビュー）生成
    - **方針:** まず STFT による低品質プレビューを表示し、表示窓長 `time_end - time_start` が閾値以下の場合のみ、バックグラウンドで CWT による高品質プレビューへ差し替える。
    - **通信:** フロントエンドは初期化時/ズーム時に fire & forget でリクエストし、プレビューの更新結果は Backend から push 通知する（フロント側でポーリングしない）。
- Undo / Redo
    - Undo/Redo の対象は「ドキュメント（Partial群・解析設定）」の変更のみとする。
    - 選択状態、ズーム/パン、表示モード等の **純UI状態** は Undo/Redo に含めない。
    - 履歴（Undo/Redoスタック）は Backend が管理し、Frontend はコマンド実行/Undo/Redo要求を送る。
- 合成（プレビュー）
    - 破壊的加算合成を行うため、Undo/Redo を繰り返すと微細な計算誤差が残る場合があるが、プレビュー用途のため許容する。
- MPE は最大 15 voice だが、パーシャルが同時に 16個以上鳴る場合は複数の SMF に分割する。
    - エクスポートは自動分割とし、同一ベース名で連番（例: `project_01.mid`, `project_02.mid`）を出力する。
- パーシャルの Amplitude を MPE のどの CC にアサインするかは、エクスポート時に指定できるようにする。
- 低い振幅のところを勝手にミュートしたり、自動でパーシャルを分割するなどの余計なことはしない。ユーザーが書いたパーシャルを最大限尊重し、1パーシャル1ノート対応を厳守する。
- リアルタイムの再生機能はつけない。ユーザーが編集のたびに、バックグラウンドでサイン波の再合成を行う。ユーザーが再合成中に再生ボタンを押しても、バックグラウンド処理が終わるまで待たせる。再生中の編集は一度止めて再度再生しないと反映されない仕様で良い。
- パーシャル数は10個から1万個程度までを想定。
- 再合成時は位相は無視して良い。partial の freq と amplitude をなめらかに繋ぎ、端点で 5ms 程度フェードインフェードアウトする
