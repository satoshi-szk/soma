# メインスレッド ブロッキング最適化プラン

## 対象範囲

- 対象: 編集中（ズーム/パン/タイル更新時）のブロッキング
- 現時点で優先度を下げる項目:
  - `open_project` / `open_audio` の起動時ブロッキング
  - `export`（`MIDI` / `Audio`）のブロッキング

## 現状の課題（編集中パス）

1. `request_spectrogram_tile` が API 呼び出し内で同期計算されている
2. frontend からタイル要求が並列バーストしやすい
3. プレビューキャッシュ掃除（`glob + sort + unlink`）がタイル書き込みごとに走る
4. Renderer の可変状態（`_prefer_local_mode`, `_local_cache`）に並行アクセス対策が明示されていない

## 目標

- ズーム/パン中の UI 応答性を維持する
- バースト時のタイル応答遅延（特に tail latency）を下げる
- キャッシュI/Oスパイクと画像読み込み失敗を減らす

## 優先実施プラン

## P0: タイル要求のバックプレッシャ + キャッシュ掃除の分離

### P0-1. frontend の in-flight 上限導入

- viewport タイル取得の同時実行数に上限を導入（例: `2〜3`）
- 既存の重複排除は維持しつつ、保留タイルを一括発行しない
- 可視領域に近いタイルを優先し、overscan は後回しにする

期待効果:

- CPU バースト緩和、API キュー詰まり低減、体感操作の安定化

### P0-2. backend の軽量アドミッション制御

- セッションごとの同時タイル計算数に上限を設ける
- キュー飽和時は古い viewport 状態の要求を優先的に破棄
- 常に最新 viewport 要求を優先

期待効果:

- 古い要求で backend が埋まる状態を防止

### P0-3. プレビューキャッシュ掃除をホットパスから外す

- タイル応答経路から毎回の `_cleanup_cache()` 呼び出しを外す
- 定期/バックグラウンド掃除ワーカーに移す
- エントリ数が閾値を超えたときのみ掃除を実行

期待効果:

- タイル応答ごとの I/O 負荷を低減
- 画像パス失効レースの発生確率を低減

## P1: 非同期タイル計算ワーカー（Process 化）

### P1-1. 専用 Spectrogram Worker Manager の導入

- 既存 snap のワーカーパターン（`monitor thread + process`）を再利用
- `render_tile` 用タスクを追加
- 古い viewport ジョブをキャンセル可能にする

### P1-2. イベント駆動でタイル完了通知

- API は `accepted + request_id` を即時返却
- 完了はイベントチャネルで通知
- frontend 側で `request_id` とタイルキャッシュを対応付けて反映

期待効果:

- 重いタイル計算が API スレッドを占有しなくなる
- 連続ズーム/パン時の詰まりを大幅に緩和

## P2: Renderer 並行実行安全性の強化

- Renderer の可変状態を排他保護する、またはワーカープロセス内利用に限定する
- local/global 切替ヒステリシスとローカルキャッシュ更新の決定性を担保する

期待効果:

- 並列要求下でのモード切替競合やキャッシュ破損リスクを低減

## 計測と検証

## 計測項目

- タイル API レイテンシ: p50 / p95 / p99
- ズーム/パン中に空白タイルが見えるフレーム数
- frontend 警告件数: `Failed to load viewport image`
- backend キュー深さ / stale request 破棄数

## 受け入れ基準（第一目標）

- バースト操作シナリオで p95 タイル応答時間を `30%` 以上改善
- `Failed to load viewport image` 警告を `80%` 以上削減
- スペクトログラム表示品質に回帰がないこと

## ロールアウト順

1. P0-1 frontend in-flight 上限
2. P0-3 キャッシュ掃除分離
3. P0-2 backend アドミッション制御
4. P1 非同期タイルワーカー
5. P2 並行実行安全性強化

## 補足

- P0 ではスペクトログラム品質ロジック（multi-res 合成、local/global 切替）は変更しない
- 各段階で計測し、効果確認後に次段へ進める
